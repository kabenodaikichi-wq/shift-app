<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç„¼ãé³¥åº—ã‚·ãƒ•ãƒˆç®¡ç† - ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é¸æŠå¯¾å¿œ</title>
    
    <!-- PWAè¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="ã‚·ãƒ•ãƒˆç®¡ç†">
    <meta name="theme-color" content="#667eea">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIueBvuOBjemzpeW6l+OCt+ODleODiOeuoeeQhiIsCiAgInNob3J0X25hbWUiOiAi44K344OV44OI566h55CGIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmZmZmYiLAogICJ0aGVtZV9jb2xvciI6ICIjNjY3ZWVhIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sLCUzY3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJyUzZSUzY3JlY3Qgd2lkdGg9JzEwMCcgaGVpZ2h0PScxMDAnIGZpbGw9JyU0YTRhNmEnLyUzZSUzY3RleHQgeD0nNTAlMjUnIHk9JzUwJTI1JyBmb250LXNpemU9JzUwJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBkeT0nLjM1ZW0nIGZpbGw9J3doaXRlJyUzZeKdjuKdjuKdviUzYy90ZXh0JTNlJTNjL3N2ZyUzZSIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sLCUzY3N2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCAxMDAgMTAwJyUzZSUzY3JlY3Qgd2lkdGg9JzEwMCcgaGVpZ2h0PScxMDAnIGZpbGw9JyU0YTRhNmEnLyUzZSUzY3RleHQgeD0nNTAlMjUnIHk9JzUwJTI1JyBmb250LXNpemU9JzUwJyB0ZXh0LWFuY2hvcj0nbWlkZGxlJyBkeT0nLjM1ZW0nIGZpbGw9J3doaXRlJyUzZeKdjuKdjuKdviUzYy90ZXh0JTNlJTNjL3N2ZyUzZSIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0KICBdCn0=">
    <link rel="apple-touch-icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3e%3crect width='100' height='100' fill='%234a4a6a'/%3e%3ctext x='50%25' y='50%25' font-size='50' text-anchor='middle' dy='.35em' fill='white'%3eğŸ¢ğŸ¢ğŸ¾%3c/text%3e%3c/svg%3e">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Hiragino Kaku Gothic Pro', 'ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ Pro', 'ãƒ¡ã‚¤ãƒªã‚ª', Meiryo, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }

        .tab {
            flex: 1;
            min-width: 120px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 15px;
            font-weight: bold;
            color: #6c757d;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            background: #e9ecef;
        }

        .tab.active {
            background: white;
            color: #f5576c;
            border-bottom: 3px solid #f5576c;
        }

        .content {
            padding: 30px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #f5576c;
        }

        .form-group small {
            display: block;
            margin-top: 5px;
            color: #6c757d;
            font-size: 12px;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-item input[type="radio"] {
            width: auto;
            margin: 0;
        }

        /* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ« */
        .calendar-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            border: 2px solid #e0e0e0;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .calendar-header h4 {
            margin: 0;
            color: #333;
        }

        .calendar-nav {
            display: flex;
            gap: 10px;
        }

        .calendar-nav button {
            padding: 8px 16px;
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .calendar-nav button:hover {
            background: #e9ecef;
        }

        .calendar-legend {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 13px;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .legend-box {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid #dee2e6;
        }

        .legend-box.available {
            background: #c8e6c9;
            border-color: #4caf50;
        }

        .legend-box.blocked {
            background: #ffcdd2;
            border-color: #f44336;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day-header {
            text-align: center;
            font-weight: bold;
            padding: 10px 5px;
            color: #666;
            font-size: 13px;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
            background: white;
        }

        .calendar-day:hover {
            border-color: #f5576c;
            transform: scale(1.05);
        }

        .calendar-day.other-month {
            color: #ccc;
            background: #f8f9fa;
        }

        .calendar-day.today {
            border-color: #667eea;
            font-weight: bold;
        }

        .calendar-day.available {
            background: #c8e6c9;
            border-color: #4caf50;
            color: #1b5e20;
        }

        .calendar-day.blocked {
            background: #ffcdd2;
            border-color: #f44336;
            color: #b71c1c;
        }

        .calendar-day.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.4);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            padding: 8px 16px;
            font-size: 14px;
            margin-left: 8px;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        .btn-clear {
            background: #fff3cd;
            color: #856404;
            border: 2px solid #ffeaa7;
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-clear:hover {
            background: #ffeaa7;
        }

        .staff-list,
        .shift-list {
            margin-top: 30px;
        }

        .staff-item,
        .shift-item {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            transition: transform 0.2s;
        }

        .staff-item:hover,
        .shift-item:hover {
            transform: translateX(5px);
            background: #e9ecef;
        }

        .staff-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .staff-info,
        .shift-info {
            flex: 1;
        }

        .staff-name,
        .shift-date {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .staff-role,
        .shift-details {
            color: #6c757d;
            font-size: 14px;
        }

        .preferences {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 6px;
            font-size: 13px;
        }

        .preferences-section {
            margin-bottom: 8px;
        }

        .date-list {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .date-tag {
            display: inline-block;
            padding: 4px 8px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 4px;
            font-size: 11px;
        }

        .blocked-date-tag {
            background: #ffebee;
            color: #c62828;
        }

        .shift-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            font-size: 13px;
        }

        .shift-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 8px;
            text-align: center;
            font-weight: bold;
            white-space: nowrap;
        }

        .shift-table td {
            padding: 8px 6px;
            border-bottom: 1px solid #e0e0e0;
            text-align: center;
            vertical-align: middle;
        }

        .shift-table tr:last-child td {
            border-bottom: none;
        }

        .shift-table tr:hover td {
            background-color: rgba(0,0,0,0.02);
        }

        #shiftTableContainer {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* å°åˆ·ãƒ»PDFç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        @media print {
            body {
                background: white !important;
                padding: 0 !important;
            }
            .container {
                box-shadow: none !important;
                border-radius: 0 !important;
                max-width: 100% !important;
            }
            .header, .tabs, .content > .tab-content:not(.active) {
                display: none !important;
            }
            .content {
                padding: 0 !important;
            }
            #view {
                display: block !important;
            }
            .print-hide {
                display: none !important;
            }
            #shiftTableContainer {
                overflow: visible !important;
            }
            .print-title {
                display: block !important;
                font-size: 18px;
                font-weight: bold;
                text-align: center;
                margin-bottom: 12px;
                color: #333;
            }
            .shift-table {
                font-size: 11px !important;
                width: 100% !important;
            }
            .shift-table th {
                background: #555 !important;
                color: white !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                padding: 6px 4px !important;
            }
            .shift-table td {
                padding: 5px 3px !important;
            }
            .shift-table button {
                background: none !important;
                border: none !important;
                color: #333 !important;
                font-size: 11px !important;
                padding: 0 !important;
                pointer-events: none;
            }
            /* å®šä¼‘æ—¥ã®èƒŒæ™¯è‰²ã‚’å°åˆ·ã§ã‚‚ç¶­æŒ */
            tr td[style*="fdecea"] {
                background: #fdecea !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            tr td[style*="fffde7"] {
                background: #fffde7 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }

        .print-title {
            display: none;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #6c757d;
        }

        .week-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .week-nav button {
            padding: 8px 16px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }

        .week-nav button:hover {
            border-color: #f5576c;
            color: #f5576c;
        }

        .week-nav span {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }

        .time-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #e3f2fd;
            color: #1976d2;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 8px;
        }

        .role-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #fff3e0;
            color: #f57c00;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        .auto-shift-section {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        .auto-shift-section h3 {
            color: #2e7d32;
            margin-bottom: 15px;
        }

        .shift-requirements {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .requirement-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
        }

        .requirement-item label {
            font-size: 13px;
            color: #555;
        }

        .requirement-item input,
        .requirement-item select {
            margin-top: 5px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .shift-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .availability-type-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .conditional-section {
            margin-top: 15px;
        }

        .section-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            margin: 0;
            color: #333;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6c757d;
        }

        .close-btn:hover {
            color: #333;
        }

        .period-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .period-selector select {
            flex: 1;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¢ ç„¼ãé³¥åº—ã‚·ãƒ•ãƒˆç®¡ç†</h1>
            <p>ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã§ç°¡å˜ã«å‹¤å‹™å¯èƒ½æ—¥ã‚’é¸æŠ</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('staff')">ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†</button>
            <button class="tab" onclick="switchTab('auto')">è‡ªå‹•ä½œæˆ</button>
            <button class="tab" onclick="switchTab('shift')">æ‰‹å‹•ç™»éŒ²</button>
            <button class="tab" onclick="switchTab('view')">ã‚·ãƒ•ãƒˆè¡¨ç¤º</button>
        </div>

        <div class="content">
            <!-- ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†ã‚¿ãƒ– -->
            <div id="staff" class="tab-content active">
                <h2 style="margin-bottom: 20px; color: #333;">ã‚¹ã‚¿ãƒƒãƒ•ç®¡ç†</h2>
                
                <div class="form-group">
                    <label>ã‚¹ã‚¿ãƒƒãƒ•å</label>
                    <input type="text" id="staffName" placeholder="ä¾‹: ç”°ä¸­ å¤ªéƒ"></div>

                <div class="availability-type-section">
                    <div class="form-group">
                        <label>å‹¤å‹™å¯èƒ½ãƒ‘ã‚¿ãƒ¼ãƒ³</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="typeWeekday" name="availabilityType" value="weekday" checked onchange="updateAvailabilityForm()">
                                <label for="typeWeekday">æ›œæ—¥æŒ‡å®š</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="typeSpecific" name="availabilityType" value="specific" onchange="updateAvailabilityForm()">
                                <label for="typeSpecific">æ—¥ä»˜æŒ‡å®šï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼‰</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="typeFlexible" name="availabilityType" value="flexible" onchange="updateAvailabilityForm()">
                                <label for="typeFlexible">ã„ã¤ã§ã‚‚OK</label>
                            </div>
                        </div>
                    </div>

                    <!-- æ›œæ—¥æŒ‡å®šã®å ´åˆ -->
                    <div id="weekdaySection" class="conditional-section">
                        <div class="section-title">å‹¤å‹™å¯èƒ½æ›œæ—¥</div>
                        <div class="checkbox-group">
                            <div class="checkbox-item">
                                <input type="checkbox" id="day0" value="0">
                                <label for="day0">æ—¥</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="day1" value="1">
                                <label for="day1">æœˆ</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="day2" value="2">
                                <label for="day2">ç«</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="day3" value="3">
                                <label for="day3">æ°´</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="day4" value="4">
                                <label for="day4">æœ¨</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="day5" value="5">
                                <label for="day5">é‡‘</label>
                            </div>
                            <div class="checkbox-item">
                                <input type="checkbox" id="day6" value="6">
                                <label for="day6">åœŸ</label>
                            </div>
                        </div>
                    </div>

                    <!-- æ—¥ä»˜æŒ‡å®šã®å ´åˆ -->
                    <div id="specificSection" class="conditional-section" style="display: none;">
                        <div class="section-title">å‹¤å‹™å¯èƒ½æ—¥ã‚’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰é¸æŠ</div>
                        <div id="availableCalendar"></div>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-clear btn-small" onclick="clearAvailableDates()">é¸æŠã‚’ã‚¯ãƒªã‚¢</button>
                        </div>
                    </div>

                    <!-- ã„ã¤ã§ã‚‚OKã®å ´åˆ -->
                    <div id="flexibleSection" class="conditional-section" style="display: none;">
                        <div class="alert-info" style="padding: 10px; border-radius: 6px;">
                            åŸºæœ¬çš„ã«ã„ã¤ã§ã‚‚å‹¤å‹™å¯èƒ½ã§ã™ã€‚å…¥ã‚Œãªã„æ—¥ãŒã‚ã‚‹å ´åˆã¯ä¸‹ã®ã€Œå…¥ã‚Œãªã„æ—¥ã€ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label>å…¥ã‚Œãªã„æ—¥ã‚’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰é¸æŠ</label>
                    <div id="blockedCalendar"></div>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-clear btn-small" onclick="clearBlockedDates()">é¸æŠã‚’ã‚¯ãƒªã‚¢</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>é€±ã®æœ€å¤§å‹¤å‹™æ—¥æ•°</label>
                    <input type="number" id="maxDaysPerWeek" min="1" max="7" value="5">
                </div>
                
                <div class="alert-info" style="padding: 10px; border-radius: 6px; margin-bottom: 20px;">
                    <strong>ğŸ“Œ å‹¤å‹™æ™‚é–“:</strong><br>
                    å¹³æ—¥ï¼ˆæœˆã€œæœ¨ï¼‰: 18:00-22:00<br>
                    é€±æœ«ï¼ˆé‡‘åœŸæ—¥ï¼‰ãƒ»ç¥æ—¥: 17:00-22:00
                </div>

                <button class="btn btn-primary" onclick="addStaff()">ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ </button>

                <div class="staff-list" id="staffList"></div>
            </div>

            <!-- è‡ªå‹•ã‚·ãƒ•ãƒˆä½œæˆã‚¿ãƒ– -->
            <div id="auto" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #333;">è‡ªå‹•ã‚·ãƒ•ãƒˆä½œæˆ</h2>

                <div class="alert alert-info">
                    <strong>ğŸ“‹ ã‚·ãƒ•ãƒˆä½œæˆã®å„ªå…ˆé †ä½:</strong><br>
                    <span style="background:#e3f2fd;color:#1565c0;padding:1px 6px;border-radius:8px;font-size:12px;">â‘ æ›œæ—¥å›ºå®š</span>ã€€ã‚’å…ˆã«ç¢ºå®š â†’
                    <span style="background:#f3e5f5;color:#6a1b9a;padding:1px 6px;border-radius:8px;font-size:12px;">â‘¡æ—¥ä»˜æŒ‡å®š</span>ã€€ã§è£œå…… â†’
                    <span style="background:#e8f5e9;color:#2e7d32;padding:1px 6px;border-radius:8px;font-size:12px;">â‘¢ãƒ•ãƒ¬ã‚­ã‚·ãƒ–ãƒ«</span>ã€€ã§æ®‹ã‚Šã‚’åŸ‹ã‚ã‚‹
                </div>

                <div class="auto-shift-section">
                    <h3>ã‚·ãƒ•ãƒˆä½œæˆæœŸé–“</h3>
                    
                    <div class="period-selector">
                        <select id="autoYear">
                            <!-- JavaScriptã§ç”Ÿæˆ -->
                        </select>
                        <select id="autoMonth">
                            <option value="1">1æœˆ</option>
                            <option value="2">2æœˆ</option>
                            <option value="3">3æœˆ</option>
                            <option value="4">4æœˆ</option>
                            <option value="5">5æœˆ</option>
                            <option value="6">6æœˆ</option>
                            <option value="7">7æœˆ</option>
                            <option value="8">8æœˆ</option>
                            <option value="9">9æœˆ</option>
                            <option value="10">10æœˆ</option>
                            <option value="11">11æœˆ</option>
                            <option value="12">12æœˆ</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>ä½œæˆæœŸé–“</label>
                        <div class="radio-group">
                            <div class="radio-item">
                                <input type="radio" id="periodFirstHalf" name="period" value="first" checked>
                                <label for="periodFirstHalf">å‰åŠï¼ˆ1æ—¥ã€œ15æ—¥ï¼‰</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="periodSecondHalf" name="period" value="second">
                                <label for="periodSecondHalf">å¾ŒåŠï¼ˆ16æ—¥ã€œæœˆæœ«ï¼‰</label>
                            </div>
                            <div class="radio-item">
                                <input type="radio" id="periodFull" name="period" value="full">
                                <label for="periodFull">1ãƒ¶æœˆå…¨ä½“</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ç¥æ—¥ï¼ˆ17:00-22:00ã«ãªã‚‹æ—¥ï¼‰</label>
                        <textarea id="holidays" placeholder="ä¾‹:&#10;2026/2/11&#10;2026/2/23&#10;&#10;ï¼ˆ1è¡Œã«1æ—¥ä»˜ã€ç©ºæ¬„ã§ã‚‚OKï¼‰"></textarea>
                        <small>ç¥æ—¥ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ãã®æ—¥ã¯17:00-22:00ã®å–¶æ¥­æ™‚é–“ã«ãªã‚Šã¾ã™</small>
                    </div>

                    <h3 style="margin-top: 20px;">1æ—¥ã®å¿…è¦äººæ•°</h3>
                    <div class="shift-requirements">
                        <div class="requirement-item">
                            <label>å¿…è¦äººæ•°</label>
                            <input type="number" id="reqTotal" min="1" value="6">
                        </div>
                    </div>

                    <div class="shift-actions">
                        <button class="btn btn-success" onclick="generateAutoShift()">ğŸ¤– è‡ªå‹•ç”Ÿæˆ</button>
                        <button class="btn btn-secondary" onclick="clearPeriodShifts()">é¸æŠæœŸé–“ã®ã‚·ãƒ•ãƒˆã‚’ã‚¯ãƒªã‚¢</button>
                        <button class="btn btn-secondary" onclick="clearAllShifts()">å…¨ã‚·ãƒ•ãƒˆã‚¯ãƒªã‚¢</button>
                    </div>
                </div>

                <div id="autoShiftResult"></div>
            </div>

            <!-- æ‰‹å‹•ã‚·ãƒ•ãƒˆç™»éŒ²ã‚¿ãƒ– -->
            <div id="shift" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #333;">æ‰‹å‹•ã‚·ãƒ•ãƒˆç™»éŒ²</h2>

                <div class="form-group">
                    <label>ã‚¹ã‚¿ãƒƒãƒ•é¸æŠ</label>
                    <select id="shiftStaff">
                        <option value="">ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>æ—¥ä»˜</label>
                    <input type="date" id="shiftDate">
                </div>

                <div class="form-group">
                    <label>é–‹å§‹æ™‚é–“</label>
                    <input type="time" id="shiftStart">
                </div>

                <div class="form-group">
                    <label>çµ‚äº†æ™‚é–“</label>
                    <input type="time" id="shiftEnd">
                </div>

                <button class="btn btn-primary" onclick="addShift()">ã‚·ãƒ•ãƒˆã‚’ç™»éŒ²</button>

                <div class="shift-list" id="shiftList"></div>
            </div>

            <!-- ã‚·ãƒ•ãƒˆè¡¨ç¤ºã‚¿ãƒ– -->
            <div id="view" class="tab-content">
                <h2 style="margin-bottom: 20px; color: #333;">ã‚·ãƒ•ãƒˆè¡¨</h2>

                <div class="period-selector">
                    <select id="viewYear">
                        <!-- JavaScriptã§ç”Ÿæˆ -->
                    </select>
                    <select id="viewMonth">
                        <option value="1">1æœˆ</option>
                        <option value="2">2æœˆ</option>
                        <option value="3">3æœˆ</option>
                        <option value="4">4æœˆ</option>
                        <option value="5">5æœˆ</option>
                        <option value="6">6æœˆ</option>
                        <option value="7">7æœˆ</option>
                        <option value="8">8æœˆ</option>
                        <option value="9">9æœˆ</option>
                        <option value="10">10æœˆ</option>
                        <option value="11">11æœˆ</option>
                        <option value="12">12æœˆ</option>
                    </select>
                </div>

                <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:4px;">
                    <div class="week-nav print-hide" style="margin-bottom:0; flex:1;">
                        <button onclick="changeViewPeriod('first')">å‰åŠï¼ˆ1-15æ—¥ï¼‰</button>
                        <button onclick="changeViewPeriod('second')">å¾ŒåŠï¼ˆ16-æœˆæœ«ï¼‰</button>
                    </div>
                    <button class="btn btn-primary print-hide" onclick="exportPDF()" style="white-space:nowrap;">
                        ğŸ“„ PDFã§å‡ºåŠ›
                    </button>
                </div>

                <div id="printTitle" class="print-title"></div>
                <div id="shiftTableContainer"></div>
            </div>
        </div>
    </div>

    <!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ã‚¹ã‚¿ãƒƒãƒ•æƒ…å ±ç·¨é›†</h3>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            <div id="editForm"></div>
        </div>
    </div>

    <script>
        let staff = [];
        let shifts = [];
        let currentDate = new Date();
        let editingStaffId = null;
        let currentViewPeriod = 'first'; // 'first' or 'second'
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ç”¨ã®ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿
        let tempAvailableDates = [];
        let tempBlockedDates = [];
        let availableCalendarMonth = new Date();
        let blockedCalendarMonth = new Date();

        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        function loadData() {
            const savedStaff = localStorage.getItem('yakitoriStaffV3');
            const savedShifts = localStorage.getItem('yakitoriShiftsV3');
            
            if (savedStaff) {
                staff = JSON.parse(savedStaff);
            }
            if (savedShifts) {
                shifts = JSON.parse(savedShifts);
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        function saveData() {
            localStorage.setItem('yakitoriStaffV3', JSON.stringify(staff));
            localStorage.setItem('yakitoriShiftsV3', JSON.stringify(shifts));
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»
        function renderCalendar(containerId, currentMonth, selectedDates, type) {
            const container = document.getElementById(containerId);
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const prevLastDay = new Date(year, month, 0);
            
            const firstDayOfWeek = firstDay.getDay();
            const lastDate = lastDay.getDate();
            const prevLastDate = prevLastDay.getDate();
            
            const todayStr = toDateStr(new Date().getFullYear(), new Date().getMonth(), new Date().getDate());
            
            let html = `
                <div class="calendar-container">
                    <div class="calendar-header">
                        <h4>${year}å¹´ ${month + 1}æœˆ</h4>
                        <div class="calendar-nav">
                            <button onclick="changeCalendarMonth('${containerId}', -1)">â—€ å‰æœˆ</button>
                            <button onclick="changeCalendarMonth('${containerId}', 1)">æ¬¡æœˆ â–¶</button>
                        </div>
                    </div>
                    <div class="calendar-legend">
                        <div class="legend-item">
                            <div class="legend-box ${type === 'available' ? 'available' : 'blocked'}"></div>
                            <span>${type === 'available' ? 'å‹¤å‹™å¯èƒ½' : 'å…¥ã‚Œãªã„æ—¥'}</span>
                        </div>
                        <div class="legend-item" style="color:#c62828; font-size:12px;">ğŸ”´ å®šä¼‘æ—¥ï¼ˆæœˆæ›œï¼‰ã¯é¸æŠä¸å¯</div>
                    </div>
                    <div class="calendar-grid">
                        <div class="calendar-day-header">æ—¥</div>
                        <div class="calendar-day-header" style="color:#c62828;">æœˆ</div>
                        <div class="calendar-day-header">ç«</div>
                        <div class="calendar-day-header">æ°´</div>
                        <div class="calendar-day-header">æœ¨</div>
                        <div class="calendar-day-header">é‡‘</div>
                        <div class="calendar-day-header">åœŸ</div>
            `;
            
            // å‰æœˆã®æ—¥ä»˜
            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                html += `<div class="calendar-day other-month disabled">${prevLastDate - i}</div>`;
            }
            
            // ä»Šæœˆã®æ—¥ä»˜
            for (let date = 1; date <= lastDate; date++) {
                const dateStr = toDateStr(year, month, date);
                const dow = new Date(year, month, date).getDay();
                const isMonday = dow === 1;
                const isToday = dateStr === todayStr;
                const isSelected = selectedDates.includes(dateStr);
                
                let classes = 'calendar-day';
                let style = '';
                if (isMonday) {
                    classes += ' disabled';
                    style = 'style="background:#f8d7da; color:#c62828; cursor:not-allowed; border-color:#f5c6cb;"';
                } else if (isToday) {
                    classes += ' today';
                }
                if (isSelected && !isMonday) {
                    classes += type === 'available' ? ' available' : ' blocked';
                }
                
                const onclick = isMonday ? '' : `onclick="toggleDate('${containerId}', '${dateStr}')"`;
                html += `<div class="${classes}" ${style} ${onclick}>${date}${isMonday ? '<br><small style="font-size:9px;">å®šä¼‘</small>' : ''}</div>`;
            }
            
            // æ¬¡æœˆã®æ—¥ä»˜ï¼ˆã‚°ãƒªãƒƒãƒ‰ã‚’åŸ‹ã‚ã‚‹ï¼‰
            const totalCells = Math.ceil((firstDayOfWeek + lastDate) / 7) * 7;
            const remainingCells = totalCells - (firstDayOfWeek + lastDate);
            for (let i = 1; i <= remainingCells; i++) {
                html += `<div class="calendar-day other-month disabled">${i}</div>`;
            }
            
            html += '</div></div>';
            container.innerHTML = html;
        }

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®æœˆã‚’å¤‰æ›´
        function changeCalendarMonth(containerId, delta) {
            if (containerId === 'availableCalendar') {
                availableCalendarMonth.setMonth(availableCalendarMonth.getMonth() + delta);
                renderCalendar('availableCalendar', availableCalendarMonth, tempAvailableDates, 'available');
            } else if (containerId === 'blockedCalendar') {
                blockedCalendarMonth.setMonth(blockedCalendarMonth.getMonth() + delta);
                renderCalendar('blockedCalendar', blockedCalendarMonth, tempBlockedDates, 'blocked');
            }
        }

        // æ—¥ä»˜ã®ãƒˆã‚°ãƒ«
        function toggleDate(containerId, dateStr) {
            if (containerId === 'availableCalendar') {
                const index = tempAvailableDates.indexOf(dateStr);
                if (index > -1) {
                    tempAvailableDates.splice(index, 1);
                } else {
                    tempAvailableDates.push(dateStr);
                }
                renderCalendar('availableCalendar', availableCalendarMonth, tempAvailableDates, 'available');
            } else if (containerId === 'blockedCalendar') {
                const index = tempBlockedDates.indexOf(dateStr);
                if (index > -1) {
                    tempBlockedDates.splice(index, 1);
                } else {
                    tempBlockedDates.push(dateStr);
                }
                renderCalendar('blockedCalendar', blockedCalendarMonth, tempBlockedDates, 'blocked');
            }
        }

        // åˆ©ç”¨å¯èƒ½æ—¥ã‚’ã‚¯ãƒªã‚¢
        function clearAvailableDates() {
            tempAvailableDates = [];
            renderCalendar('availableCalendar', availableCalendarMonth, tempAvailableDates, 'available');
        }

        // å…¥ã‚Œãªã„æ—¥ã‚’ã‚¯ãƒªã‚¢
        function clearBlockedDates() {
            tempBlockedDates = [];
            renderCalendar('blockedCalendar', blockedCalendarMonth, tempBlockedDates, 'blocked');
        }

        // åˆ©ç”¨å¯èƒ½æ€§ãƒ•ã‚©ãƒ¼ãƒ ã®è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function updateAvailabilityForm() {
            const type = document.querySelector('input[name="availabilityType"]:checked').value;
            
            document.getElementById('weekdaySection').style.display = type === 'weekday' ? 'block' : 'none';
            document.getElementById('specificSection').style.display = type === 'specific' ? 'block' : 'none';
            document.getElementById('flexibleSection').style.display = type === 'flexible' ? 'block' : 'none';
            
            if (type === 'specific') {
                renderCalendar('availableCalendar', availableCalendarMonth, tempAvailableDates, 'available');
            }
        }

        // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });

            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');

            if (tabName === 'view') {
                displayShiftTable();
            }
        }

        // ã‚¹ã‚¿ãƒƒãƒ•ã‚’è¿½åŠ 
        function addStaff() {
            const name = document.getElementById('staffName').value.trim();
            const availabilityType = document.querySelector('input[name="availabilityType"]:checked').value;
            
            if (!name) {
                alert('ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            let availableDays = [];
            let specificDates = [];
            
            if (availabilityType === 'weekday') {
                for (let i = 0; i < 7; i++) {
                    if (document.getElementById(`day${i}`).checked) {
                        availableDays.push(i);
                    }
                }
                if (availableDays.length === 0) {
                    alert('å‹¤å‹™å¯èƒ½æ›œæ—¥ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„');
                    return;
                }
            } else if (availabilityType === 'specific') {
                specificDates = [...tempAvailableDates];
                if (specificDates.length === 0) {
                    alert('å‹¤å‹™å¯èƒ½æ—¥ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„');
                    return;
                }
            }

            const blockedDates = [...tempBlockedDates];
            const maxDaysPerWeek = parseInt(document.getElementById('maxDaysPerWeek').value);

            staff.push({ 
                id: Date.now(), 
                name,
                availabilityType,
                availableDays,
                specificDates,
                blockedDates,
                maxDaysPerWeek
            });
            
            saveData();
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
            document.getElementById('staffName').value = '';
            for (let i = 0; i < 7; i++) {
                document.getElementById(`day${i}`).checked = false;
            }
            tempAvailableDates = [];
            tempBlockedDates = [];
            document.getElementById('maxDaysPerWeek').value = '5';
            
            renderCalendar('availableCalendar', availableCalendarMonth, tempAvailableDates, 'available');
            renderCalendar('blockedCalendar', blockedCalendarMonth, tempBlockedDates, 'blocked');
            
            displayStaff();
            updateStaffSelect();
        }

        // ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤
        function deleteStaff(id) {
            if (confirm('ã“ã®ã‚¹ã‚¿ãƒƒãƒ•ã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) {
                staff = staff.filter(s => s.id !== id);
                shifts = shifts.filter(sh => sh.staffId !== id);
                saveData();
                displayStaff();
                updateStaffSelect();
                displayShifts();
            }
        }

        // ã‚¹ã‚¿ãƒƒãƒ•ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openEditModal(id) {
            editingStaffId = id;
            const s = staff.find(st => st.id === id);
            if (!s) return;

            // ç·¨é›†ç”¨ã®ç‹¬ç«‹ã—ãŸä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ï¼ˆtempBlockedDatesã¨æ··åœ¨ã—ãªã„ã‚ˆã†åˆ¥å¤‰æ•°ï¼‰
            window.editAvailableDates = s.specificDates ? [...s.specificDates] : [];
            window.editBlockedDates  = s.blockedDates  ? [...s.blockedDates]  : [];
            window.editAvailCalMonth = new Date();
            window.editBlockedCalMonth = new Date();

            const dayLabels = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const checkedDays = s.availableDays || [];

            const form = document.getElementById('editForm');
            form.innerHTML = `
                <div class="form-group">
                    <label>ã‚¹ã‚¿ãƒƒãƒ•å</label>
                    <input type="text" id="editName" value="${s.name}">
                </div>
                <div class="form-group">
                    <label>å‹¤å‹™å¯èƒ½ãƒ‘ã‚¿ãƒ¼ãƒ³</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="editAvailType" value="weekday"  ${s.availabilityType === 'weekday'  ? 'checked' : ''} onchange="updateEditAvailForm()">
                            <label>æ›œæ—¥æŒ‡å®š</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="editAvailType" value="specific" ${s.availabilityType === 'specific' ? 'checked' : ''} onchange="updateEditAvailForm()">
                            <label>æ—¥ä»˜æŒ‡å®š</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="editAvailType" value="flexible" ${s.availabilityType === 'flexible' ? 'checked' : ''} onchange="updateEditAvailForm()">
                            <label>ã„ã¤ã§ã‚‚OK</label>
                        </div>
                    </div>
                </div>

                <!-- æ›œæ—¥æŒ‡å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div id="editWeekdaySection" class="conditional-section" style="display:none;">
                    <div class="section-title">å‹¤å‹™å¯èƒ½æ›œæ—¥ï¼ˆæœˆæ›œã¯å®šä¼‘ã®ãŸã‚é¸æŠä¸å¯ï¼‰</div>
                    <div class="checkbox-group">
                        ${[0,2,3,4,5,6].map(i => `
                            <div class="checkbox-item">
                                <input type="checkbox" id="editDay${i}" value="${i}" ${checkedDays.includes(i) ? 'checked' : ''}>
                                <label for="editDay${i}">${dayLabels[i]}</label>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- æ—¥ä»˜æŒ‡å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div id="editSpecificSection" class="conditional-section" style="display:none;">
                    <div class="section-title">å‹¤å‹™å¯èƒ½æ—¥ã‚’ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‹ã‚‰é¸æŠ</div>
                    <div id="editAvailCalendar"></div>
                    <button class="btn btn-clear btn-small" style="margin-top:8px;" onclick="window.editAvailableDates=[]; renderEditAvailCalendar()">é¸æŠã‚¯ãƒªã‚¢</button>
                </div>

                <!-- ã„ã¤ã§ã‚‚OKã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
                <div id="editFlexibleSection" class="conditional-section" style="display:none;">
                    <div class="alert-info" style="padding:10px; border-radius:6px;">
                        åŸºæœ¬çš„ã«ã„ã¤ã§ã‚‚å‹¤å‹™å¯èƒ½ã€‚å…¥ã‚Œãªã„æ—¥ã¯ä¸‹ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚
                    </div>
                </div>

                <div class="form-group" style="margin-top:20px;">
                    <label>é€±ã®æœ€å¤§å‹¤å‹™æ—¥æ•°</label>
                    <input type="number" id="editMaxDays" min="1" max="7" value="${s.maxDaysPerWeek || 5}">
                </div>

                <div class="form-group">
                    <label>å…¥ã‚Œãªã„æ—¥</label>
                    <div id="editBlockedCalendar"></div>
                    <button class="btn btn-clear btn-small" style="margin-top:8px;" onclick="window.editBlockedDates=[]; renderEditBlockedCalendar()">é¸æŠã‚¯ãƒªã‚¢</button>
                </div>

                <div style="margin-top:24px; display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="saveEdit()">ä¿å­˜</button>
                    <button class="btn btn-secondary" onclick="closeEditModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                </div>
            `;

            document.getElementById('editModal').classList.add('active');

            // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºã‚’åˆæœŸåŒ–ã—ã¦ã‹ã‚‰ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»
            updateEditAvailForm();
            setTimeout(() => {
                renderEditAvailCalendar();
                renderEditBlockedCalendar();
            }, 50);
        }

        // ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®å‹¤å‹™ãƒ‘ã‚¿ãƒ¼ãƒ³è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        function updateEditAvailForm() {
            const type = document.querySelector('input[name="editAvailType"]:checked')?.value;
            if (!type) return;
            document.getElementById('editWeekdaySection').style.display  = type === 'weekday'  ? 'block' : 'none';
            document.getElementById('editSpecificSection').style.display = type === 'specific' ? 'block' : 'none';
            document.getElementById('editFlexibleSection').style.display = type === 'flexible' ? 'block' : 'none';
            if (type === 'specific') renderEditAvailCalendar();
        }

        // ç·¨é›†ç”¨ãƒ»å‹¤å‹™å¯èƒ½æ—¥ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
        function renderEditAvailCalendar() {
            renderEditCalendar('editAvailCalendar', window.editAvailCalMonth, window.editAvailableDates, 'available');
        }

        // ç·¨é›†ç”¨ãƒ»å…¥ã‚Œãªã„æ—¥ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æç”»
        function renderEditBlockedCalendar() {
            renderEditCalendar('editBlockedCalendar', window.editBlockedCalMonth, window.editBlockedDates, 'blocked');
        }

        // ç·¨é›†ç”¨ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼æ±ç”¨æç”»
        function renderEditCalendar(containerId, currentMonth, selectedDates, type) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const year  = currentMonth.getFullYear();
            const month = currentMonth.getMonth();

            const firstDayOfWeek = new Date(year, month, 1).getDay();
            const lastDate       = new Date(year, month + 1, 0).getDate();
            const prevLastDate   = new Date(year, month, 0).getDate();
            const todayStr = toDateStr(new Date().getFullYear(), new Date().getMonth(), new Date().getDate());

            const navFn    = type === 'available' ? 'changeEditAvailMonth'   : 'changeEditBlockedMonth';
            const toggleFn = type === 'available' ? 'toggleEditAvailDate'    : 'toggleEditBlockedDate';
            const colorClass = type === 'available' ? 'available' : 'blocked';

            let html = `
                <div class="calendar-container">
                    <div class="calendar-header">
                        <h4>${year}å¹´ ${month + 1}æœˆ</h4>
                        <div class="calendar-nav">
                            <button onclick="${navFn}(-1)">â—€ å‰æœˆ</button>
                            <button onclick="${navFn}(1)">æ¬¡æœˆ â–¶</button>
                        </div>
                    </div>
                    <div class="calendar-grid">
                        <div class="calendar-day-header">æ—¥</div>
                        <div class="calendar-day-header" style="color:#c62828;">æœˆ</div>
                        <div class="calendar-day-header">ç«</div>
                        <div class="calendar-day-header">æ°´</div>
                        <div class="calendar-day-header">æœ¨</div>
                        <div class="calendar-day-header">é‡‘</div>
                        <div class="calendar-day-header">åœŸ</div>`;

            for (let i = firstDayOfWeek - 1; i >= 0; i--) {
                html += `<div class="calendar-day other-month disabled">${prevLastDate - i}</div>`;
            }

            for (let date = 1; date <= lastDate; date++) {
                const dateStr  = toDateStr(year, month, date);
                const dow      = new Date(year, month, date).getDay();
                const isMonday = dow === 1;
                const isToday  = dateStr === todayStr;
                const isSel    = selectedDates.includes(dateStr);

                let cls   = 'calendar-day';
                let style = '';
                if (isMonday) {
                    cls   += ' disabled';
                    style  = 'style="background:#f8d7da;color:#c62828;cursor:not-allowed;border-color:#f5c6cb;"';
                } else {
                    if (isToday) cls += ' today';
                    if (isSel)   cls += ` ${colorClass}`;
                }
                const onclick = isMonday ? '' : `onclick="${toggleFn}('${dateStr}')"`;
                html += `<div class="${cls}" ${style} ${onclick}>${date}${isMonday ? '<br><small style="font-size:9px;">å®šä¼‘</small>' : ''}</div>`;
            }

            const total = Math.ceil((firstDayOfWeek + lastDate) / 7) * 7;
            for (let i = 1; i <= total - (firstDayOfWeek + lastDate); i++) {
                html += `<div class="calendar-day other-month disabled">${i}</div>`;
            }

            html += '</div></div>';
            container.innerHTML = html;
        }

        function changeEditAvailMonth(delta) {
            window.editAvailCalMonth.setMonth(window.editAvailCalMonth.getMonth() + delta);
            renderEditAvailCalendar();
        }
        function changeEditBlockedMonth(delta) {
            window.editBlockedCalMonth.setMonth(window.editBlockedCalMonth.getMonth() + delta);
            renderEditBlockedCalendar();
        }
        function toggleEditAvailDate(dateStr) {
            const idx = window.editAvailableDates.indexOf(dateStr);
            if (idx > -1) window.editAvailableDates.splice(idx, 1);
            else          window.editAvailableDates.push(dateStr);
            renderEditAvailCalendar();
        }
        function toggleEditBlockedDate(dateStr) {
            const idx = window.editBlockedDates.indexOf(dateStr);
            if (idx > -1) window.editBlockedDates.splice(idx, 1);
            else          window.editBlockedDates.push(dateStr);
            renderEditBlockedCalendar();
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            editingStaffId = null;
        }

        function saveEdit() {
            const s = staff.find(st => st.id === editingStaffId);
            if (!s) return;

            const name = document.getElementById('editName').value.trim();
            if (!name) { alert('ã‚¹ã‚¿ãƒƒãƒ•åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

            const availType = document.querySelector('input[name="editAvailType"]:checked').value;

            let availableDays  = [];
            let specificDates  = [];

            if (availType === 'weekday') {
                [0,2,3,4,5,6].forEach(i => {
                    if (document.getElementById(`editDay${i}`)?.checked) availableDays.push(i);
                });
                if (availableDays.length === 0) { alert('å‹¤å‹™å¯èƒ½æ›œæ—¥ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„'); return; }
            } else if (availType === 'specific') {
                specificDates = [...window.editAvailableDates];
                if (specificDates.length === 0) { alert('å‹¤å‹™å¯èƒ½æ—¥ã‚’1ã¤ä»¥ä¸Šé¸æŠã—ã¦ãã ã•ã„'); return; }
            }

            s.name             = name;
            s.availabilityType = availType;
            s.availableDays    = availableDays;
            s.specificDates    = specificDates;
            s.blockedDates     = [...window.editBlockedDates];
            s.maxDaysPerWeek   = parseInt(document.getElementById('editMaxDays').value) || 5;

            saveData();
            displayStaff();
            updateStaffSelect();
            closeEditModal();
        }

        // ã‚¹ã‚¿ãƒƒãƒ•ä¸€è¦§ã‚’è¡¨ç¤º
        function displayStaff() {
            const listEl = document.getElementById('staffList');
            const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            
            if (staff.length === 0) {
                listEl.innerHTML = '<div class="empty-state"><p>ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p></div>';
                return;
            }

            listEl.innerHTML = staff.map(s => {
                let availabilityText = '';
                let priorityBadge = '';
                if (s.availabilityType === 'weekday') {
                    availabilityText = `ğŸ“… ${s.availableDays.map(d => days[d]).join(', ')}`;
                    priorityBadge = '<span style="background:#e3f2fd;color:#1565c0;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:bold;">å„ªå…ˆâ‘ æ›œæ—¥å›ºå®š</span>';
                } else if (s.availabilityType === 'specific') {
                    availabilityText = `ğŸ“… æ—¥ä»˜æŒ‡å®š (${s.specificDates.length}æ—¥)`;
                    priorityBadge = '<span style="background:#f3e5f5;color:#6a1b9a;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:bold;">å„ªå…ˆâ‘¡æ—¥ä»˜æŒ‡å®š</span>';
                } else {
                    availabilityText = 'ğŸ“… ã„ã¤ã§ã‚‚OK';
                    priorityBadge = '<span style="background:#e8f5e9;color:#2e7d32;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:bold;">å„ªå…ˆâ‘¢ãƒ•ãƒ¬ã‚­ã‚·ãƒ–ãƒ«</span>';
                }
                
                let blockedText = '';
                if (s.blockedDates && s.blockedDates.length > 0) {
                    blockedText = `<div class="preferences-section">
                        <div class="preferences-label">â›” å…¥ã‚Œãªã„æ—¥:</div>
                        <div class="date-list">
                            ${s.blockedDates.slice(0, 5).map(d => `<span class="date-tag blocked-date-tag">${formatDateShort(d)}</span>`).join('')}
                            ${s.blockedDates.length > 5 ? `<span class="date-tag blocked-date-tag">ä»–${s.blockedDates.length - 5}æ—¥</span>` : ''}
                        </div>
                    </div>`;
                }

                let specificDatesText = '';
                if (s.availabilityType === 'specific' && s.specificDates && s.specificDates.length > 0) {
                    specificDatesText = `<div class="preferences-section">
                        <div class="preferences-label">âœ… å‹¤å‹™å¯èƒ½æ—¥:</div>
                        <div class="date-list">
                            ${s.specificDates.slice(0, 5).map(d => `<span class="date-tag">${formatDateShort(d)}</span>`).join('')}
                            ${s.specificDates.length > 5 ? `<span class="date-tag">ä»–${s.specificDates.length - 5}æ—¥</span>` : ''}
                        </div>
                    </div>`;
                }
                
                return `
                <div class="staff-item">
                    <div class="staff-header">
                        <div class="staff-info">
                            <div class="staff-name">${s.name}</div>
                        </div>
                        <div>
                            <button class="btn btn-secondary btn-small" onclick="openEditModal(${s.id})">ç·¨é›†</button>
                            <button class="btn btn-danger btn-small" onclick="deleteStaff(${s.id})">å‰Šé™¤</button>
                        </div>
                    </div>
                    <div class="preferences">
                        <div class="preferences-section">
                            <div style="margin-bottom:5px;">${priorityBadge}</div>
                            <div>${availabilityText} (é€±${s.maxDaysPerWeek}æ—¥ã¾ã§)</div>
                        </div>
                        ${specificDatesText}
                        ${blockedText}
                    </div>
                </div>`;
            }).join('');
        }

        // çŸ­ã„æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDateShort(dateStr) {
            const d = localDate(dateStr);
            return `${d.getMonth() + 1}/${d.getDate()}`;
        }

        // ã‚¹ã‚¿ãƒƒãƒ•é¸æŠè‚¢ã‚’æ›´æ–°
        function updateStaffSelect() {
            const select = document.getElementById('shiftStaff');
            select.innerHTML = '<option value="">ã‚¹ã‚¿ãƒƒãƒ•ã‚’é¸æŠã—ã¦ãã ã•ã„</option>' +
                staff.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
        }

        // æ—¥ä»˜æ–‡å­—åˆ—ã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆYYYY/M/D â†’ "YYYY-MM-DD"ï¼‰
        function parseDateString(str) {
            const trimmed = str.trim();
            if (!trimmed) return null;
            const parts = trimmed.split(/[/-]/);
            if (parts.length !== 3) return null;
            const year = parseInt(parts[0]);
            const month = parseInt(parts[1]);
            const day = parseInt(parts[2]);
            if (isNaN(year) || isNaN(month) || isNaN(day)) return null;
            // ãƒ­ãƒ¼ã‚«ãƒ«æ—¥ä»˜ã¨ã—ã¦æ–‡å­—åˆ—ã‚’ä½œæˆï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã®ã‚ºãƒ¬ãªã—ï¼‰
            return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }

        // dateStrï¼ˆ"YYYY-MM-DD"ï¼‰ã‹ã‚‰ãƒ­ãƒ¼ã‚«ãƒ«Dateã‚’ä½œæˆ
        function localDate(dateStr) {
            const [y, m, d] = dateStr.split('-').map(Number);
            return new Date(y, m - 1, d);
        }

        // dateStr ã‹ã‚‰æ›œæ—¥ç•ªå·ã‚’è¿”ã™ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³å®‰å…¨ï¼‰
        function getDayOfWeek(dateStr) {
            return localDate(dateStr).getDay();
        }

        // dateStr ã‚’ "YYYY-MM-DD" å½¢å¼ã§ç”Ÿæˆï¼ˆå¹´æœˆæ—¥ã‹ã‚‰ï¼‰
        function toDateStr(year, month, day) {
            return `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }

        // æœˆæ›œå®šä¼‘ã‹ã©ã†ã‹
        function isClosedDay(dateStr) {
            return getDayOfWeek(dateStr) === 1; // 1 = æœˆæ›œ
        }

        // ç‰¹å®šã®æ—¥ã«ã‚¹ã‚¿ãƒƒãƒ•ãŒå‹¤å‹™å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
        function isStaffAvailable(staffMember, dateStr) {
            // æœˆæ›œã¯å®šä¼‘
            if (isClosedDay(dateStr)) return false;

            // å…¥ã‚Œãªã„æ—¥ãƒã‚§ãƒƒã‚¯
            if (staffMember.blockedDates && staffMember.blockedDates.includes(dateStr)) {
                return false;
            }

            const dayOfWeek = getDayOfWeek(dateStr);

            if (staffMember.availabilityType === 'weekday') {
                return staffMember.availableDays.includes(dayOfWeek);
            } else if (staffMember.availabilityType === 'specific') {
                return staffMember.specificDates.includes(dateStr);
            } else if (staffMember.availabilityType === 'flexible') {
                return true;
            }
            return false;
        }

        // å‹¤å‹™æ™‚é–“ã‚’å–å¾—ï¼ˆå¹³æ—¥ or é€±æœ«ãƒ»ç¥æ—¥ï¼‰
        // å®šä¼‘ã®æœˆæ›œã¯å‘¼ã°ã‚Œãªã„æƒ³å®šã ãŒå¿µã®ãŸã‚
        function getShiftHours(dateStr, holidays) {
            const dow = getDayOfWeek(dateStr);
            // é‡‘(5)åœŸ(6)æ—¥(0) ã¾ãŸã¯ç¥æ—¥ â†’ 17:00-22:00
            if (dow === 5 || dow === 6 || dow === 0 || holidays.includes(dateStr)) {
                return { start: '17:00', end: '22:00' };
            }
            // ç«æ°´æœ¨ â†’ 18:00-22:00
            return { start: '18:00', end: '22:00' };
        }

        // è‡ªå‹•ã‚·ãƒ•ãƒˆç”Ÿæˆ
        function generateAutoShift() {
            if (staff.length === 0) {
                alert('ã‚¹ã‚¿ãƒƒãƒ•ã‚’å…ˆã«ç™»éŒ²ã—ã¦ãã ã•ã„');
                return;
            }

            const year = parseInt(document.getElementById('autoYear').value);
            const month = parseInt(document.getElementById('autoMonth').value) - 1;
            const period = document.querySelector('input[name="period"]:checked').value;

            // ç¥æ—¥ã‚’ãƒ‘ãƒ¼ã‚¹
            const holidaysText = document.getElementById('holidays').value;
            const holidays = holidaysText.split('\n')
                .map(line => parseDateString(line))
                .filter(d => d !== null);

            const reqTotal = parseInt(document.getElementById('reqTotal').value) || 6;

            let startDay, endDay;
            if (period === 'first') {
                startDay = 1; endDay = 15;
            } else if (period === 'second') {
                startDay = 16;
                endDay = new Date(year, month + 1, 0).getDate();
            } else {
                startDay = 1;
                endDay = new Date(year, month + 1, 0).getDate();
            }

            const newShifts = [];
            const staffWorkCount = {};
            const warnings = [];
            
            staff.forEach(s => { staffWorkCount[s.id] = 0; });

            let currentWeekKey = null;

            for (let day = startDay; day <= endDay; day++) {
                const dateStr = toDateStr(year, month, day);

                // æœˆæ›œã¯å®šä¼‘ â†’ ã‚¹ã‚­ãƒƒãƒ—
                if (isClosedDay(dateStr)) continue;

                // é€±ãŒå¤‰ã‚ã£ãŸã‚‰é€±å‹¤å‹™ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
                const weekKey = getWeekKey(dateStr);
                if (weekKey !== currentWeekKey) {
                    currentWeekKey = weekKey;
                    staff.forEach(s => { staffWorkCount[s.id] = 0; });
                }

                const hours = getShiftHours(dateStr, holidays);

                const availableStaff = staff.filter(s =>
                    isStaffAvailable(s, dateStr) &&
                    staffWorkCount[s.id] < s.maxDaysPerWeek
                );

                const assigned = assignStaff(availableStaff, reqTotal, staffWorkCount);
                assigned.forEach(s => {
                    newShifts.push({
                        id: Date.now() + Math.random(),
                        staffId: s.id,
                        staffName: s.name,
                        date: dateStr,
                        start: hours.start,
                        end: hours.end
                    });
                });

                // äººæ•°ä¸è¶³ã®è­¦å‘Š
                if (assigned.length < reqTotal) {
                    warnings.push(`${formatDate(dateStr)}: ${assigned.length}/${reqTotal}äºº`);
                }
            }

            // æ—¢å­˜ã®ã‚·ãƒ•ãƒˆã‚’ãã®æœŸé–“ã ã‘å‰Šé™¤ã—ã¦æ–°ã—ã„ã‚‚ã®ã‚’è¿½åŠ 
            shifts = shifts.filter(sh => {
                const [sy, sm, sd] = sh.date.split('-').map(Number);
                const shDay = sd;
                const shMonth = sm - 1;
                return !(shMonth === month && shDay >= startDay && shDay <= endDay);
            });

            shifts.push(...newShifts);
            saveData();

            const periodText = period === 'first' ? 'å‰åŠ' : period === 'second' ? 'å¾ŒåŠ' : 'å…¨ä½“';
            let warningHTML = '';
            if (warnings.length > 0) {
                warningHTML = `
                    <div class="alert alert-warning">
                        <strong>âš ï¸ äººæ•°ä¸è¶³ã®æ—¥ãŒã‚ã‚Šã¾ã™:</strong><br>
                        ${warnings.slice(0, 10).join('<br>')}
                        ${warnings.length > 10 ? `<br>... ä»– ${warnings.length - 10}ä»¶` : ''}
                    </div>`;
            }

            document.getElementById('autoShiftResult').innerHTML = `
                <div class="alert alert-info">
                    <strong>âœ… ã‚·ãƒ•ãƒˆç”Ÿæˆå®Œäº†!</strong><br>
                    ${year}å¹´${month + 1}æœˆ${periodText}ï¼ˆ${startDay}æ—¥ã€œ${endDay}æ—¥ï¼‰ã®${newShifts.length}ä»¶ã®ã‚·ãƒ•ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚<br>
                    â€»æœˆæ›œæ—¥ï¼ˆå®šä¼‘æ—¥ï¼‰ã¯è‡ªå‹•çš„ã«ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¦ã„ã¾ã™ã€‚
                </div>
                ${warningHTML}`;

            displayShifts();
        }

        // é€±ã®è­˜åˆ¥ã‚­ãƒ¼ã‚’å–å¾—ï¼ˆãã®é€±ã®æ—¥æ›œæ—¥ã®æ—¥ä»˜æ–‡å­—åˆ—ï¼‰
        function getWeekKey(dateStr) {
            const d = localDate(dateStr);
            d.setDate(d.getDate() - d.getDay());
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }

        // ã‚¹ã‚¿ãƒƒãƒ•ã‚’ã‚·ãƒ•ãƒˆã«å‰²ã‚Šå½“ã¦
        // å„ªå…ˆé †ä½: 1.æ›œæ—¥å›ºå®š â†’ 2.æ—¥ä»˜æŒ‡å®š â†’ 3.ã„ã¤ã§ã‚‚OK
        // åŒå„ªå…ˆåº¦å†…ã§ã¯é€±å‹¤å‹™æ•°ãŒå°‘ãªã„äººã‚’å„ªå…ˆï¼ˆå‡ç­‰åŒ–ï¼‰
        function assignStaff(availableStaff, required, workCount) {
            // å„ªå…ˆåº¦ã‚°ãƒ«ãƒ¼ãƒ—ã«åˆ†é¡
            const group1 = availableStaff.filter(s => s.availabilityType === 'weekday');
            const group2 = availableStaff.filter(s => s.availabilityType === 'specific');
            const group3 = availableStaff.filter(s => s.availabilityType === 'flexible');

            // å„ã‚°ãƒ«ãƒ¼ãƒ—å†…ã§å‹¤å‹™æ—¥æ•°ãŒå°‘ãªã„é †ã«ã‚½ãƒ¼ãƒˆ
            const sortByCount = arr => [...arr].sort((a, b) => workCount[a.id] - workCount[b.id]);

            const assigned = [];
            const addFrom = (group) => {
                for (const s of sortByCount(group)) {
                    if (assigned.length >= required) break;
                    if (!assigned.includes(s)) {
                        assigned.push(s);
                    }
                }
            };

            addFrom(group1); // æ›œæ—¥å›ºå®šã‚’å…ˆã«åŸ‹ã‚ã‚‹
            addFrom(group2); // æ¬¡ã«æ—¥ä»˜æŒ‡å®š
            addFrom(group3); // æœ€å¾Œã«ã„ã¤ã§ã‚‚OK

            assigned.forEach(s => { workCount[s.id]++; });
            return assigned;
        }

        // é¸æŠæœŸé–“ã®ã‚·ãƒ•ãƒˆã‚¯ãƒªã‚¢
        function clearPeriodShifts() {
            const year = parseInt(document.getElementById('autoYear').value);
            const month = parseInt(document.getElementById('autoMonth').value) - 1;
            const period = document.querySelector('input[name="period"]:checked').value;

            let startDay, endDay;
            
            if (period === 'first') {
                startDay = 1;
                endDay = 15;
            } else if (period === 'second') {
                startDay = 16;
                const lastDay = new Date(year, month + 1, 0);
                endDay = lastDay.getDate();
            } else { // full
                startDay = 1;
                const lastDay = new Date(year, month + 1, 0);
                endDay = lastDay.getDate();
            }

            const periodText = period === 'first' ? 'å‰åŠ' : period === 'second' ? 'å¾ŒåŠ' : 'å…¨ä½“';

            if (confirm(`${year}å¹´${month + 1}æœˆ${periodText}ã®ã‚·ãƒ•ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                const startDate = new Date(year, month, startDay);
                const endDate = new Date(year, month, endDay);

                shifts = shifts.filter(sh => {
                    const shiftDate = new Date(sh.date);
                    return shiftDate < startDate || shiftDate > endDate;
                });

                saveData();
                displayShifts();
                document.getElementById('autoShiftResult').innerHTML = '';
                alert('é¸æŠæœŸé–“ã®ã‚·ãƒ•ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }

        // å…¨ã‚·ãƒ•ãƒˆã‚¯ãƒªã‚¢
        function clearAllShifts() {
            if (confirm('ã™ã¹ã¦ã®ã‚·ãƒ•ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
                shifts = [];
                saveData();
                displayShifts();
                document.getElementById('autoShiftResult').innerHTML = '';
                alert('ã™ã¹ã¦ã®ã‚·ãƒ•ãƒˆã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
            }
        }

        // æ‰‹å‹•ã§ã‚·ãƒ•ãƒˆã‚’è¿½åŠ 
        function addShift() {
            const staffId = parseInt(document.getElementById('shiftStaff').value);
            const date = document.getElementById('shiftDate').value;
            const start = document.getElementById('shiftStart').value;
            const end = document.getElementById('shiftEnd').value;

            if (!staffId || !date || !start || !end) {
                alert('ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
            }

            const staffMember = staff.find(s => s.id === staffId);
            
            shifts.push({
                id: Date.now(),
                staffId,
                staffName: staffMember.name,
                staffRole: staffMember.role,
                date,
                start,
                end
            });

            saveData();
            
            document.getElementById('shiftDate').value = '';
            document.getElementById('shiftStart').value = '';
            document.getElementById('shiftEnd').value = '';
            
            displayShifts();
        }

        // ã‚·ãƒ•ãƒˆã‚’å‰Šé™¤
        function deleteShift(id) {
            if (confirm('ã“ã®ã‚·ãƒ•ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹?')) {
                shifts = shifts.filter(sh => sh.id !== id);
                saveData();
                displayShifts();
            }
        }

        // ã‚·ãƒ•ãƒˆä¸€è¦§ã‚’è¡¨ç¤º
        function displayShifts() {
            const listEl = document.getElementById('shiftList');
            
            if (shifts.length === 0) {
                listEl.innerHTML = '<div class="empty-state"><p>ã‚·ãƒ•ãƒˆãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p></div>';
                return;
            }

            const sortedShifts = [...shifts].sort((a, b) => 
                new Date(b.date + ' ' + b.start) - new Date(a.date + ' ' + a.start)
            );

            listEl.innerHTML = sortedShifts.slice(0, 20).map(sh => `
                <div class="shift-item">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="shift-info">
                            <div class="shift-date">${formatDate(sh.date)} - ${sh.staffName}</div>
                            <div class="shift-details">
                                <span class="time-badge">${sh.start} - ${sh.end}</span>
                                <span class="role-badge">${sh.staffRole}</span>
                            </div>
                        </div>
                        <button class="btn btn-danger" onclick="deleteShift(${sh.id})">å‰Šé™¤</button>
                    </div>
                </div>
            `).join('');

            if (sortedShifts.length > 20) {
                listEl.innerHTML += `<div class="empty-state"><p>... ä»– ${sortedShifts.length - 20}ä»¶</p></div>`;
            }
        }

        // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDate(dateStr) {
            const d = localDate(dateStr);
            const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            return `${d.getMonth() + 1}/${d.getDate()}(${days[d.getDay()]})`;
        }

        // è¡¨ç¤ºæœŸé–“ã‚’å¤‰æ›´
        function changeViewPeriod(period) {
            currentViewPeriod = period;
            displayShiftTable();
        }

        // ã‚·ãƒ•ãƒˆè¡¨ã‚’è¡¨ç¤ºï¼ˆåŠæœˆå˜ä½ãƒ»æ™‚é–“è¡¨ç¤ºãƒ»ã‚¿ãƒƒãƒ—ç·¨é›†å¯¾å¿œï¼‰
        function displayShiftTable() {
            const year  = parseInt(document.getElementById('viewYear').value);
            const month = parseInt(document.getElementById('viewMonth').value) - 1;

            let startDay, endDay;
            if (currentViewPeriod === 'first') {
                startDay = 1; endDay = 15;
            } else {
                startDay = 16;
                endDay = new Date(year, month + 1, 0).getDate();
            }

            const container = document.getElementById('shiftTableContainer');
            const dayNames = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];

            if (staff.length === 0) {
                container.innerHTML = '<div class="empty-state"><p>ã‚¹ã‚¿ãƒƒãƒ•ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</p></div>';
                return;
            }

            let html = `
                <div style="margin-bottom:8px; font-size:12px; color:#666; display:flex; gap:16px; flex-wrap:wrap;">
                    <span>ğŸ”´ å®šä¼‘æ—¥ï¼ˆæœˆï¼‰</span>
                    <span>ğŸŸ¡ é€±æœ«ãƒ»ç¥æ—¥</span>
                    <span>ğŸ”µ å¹³æ—¥</span>
                    <span style="color:#1976d2;">æ™‚é–“ã‚’ã‚¿ãƒƒãƒ— â†’ ç·¨é›†ãƒ»å‰Šé™¤</span>
                    <span style="color:#388e3c;">âˆ’ ã‚’ã‚¿ãƒƒãƒ— â†’ ã‚·ãƒ•ãƒˆè¿½åŠ </span>
                </div>
                <table class="shift-table">
                    <thead><tr>
                        <th style="min-width:88px; position:sticky; left:0; z-index:2; background:linear-gradient(135deg,#667eea,#764ba2);">æ—¥ä»˜</th>`;

            staff.forEach(s => {
                const shortName = s.name.length > 4 ? s.name.slice(0, 4) + 'â€¦' : s.name;
                html += `<th style="min-width:70px;" title="${s.name}">${shortName}</th>`;
            });
            html += '</tr></thead><tbody>';

            for (let day = startDay; day <= endDay; day++) {
                const dateStr   = toDateStr(year, month, day);
                const dow       = getDayOfWeek(dateStr);
                const dayName   = dayNames[dow];
                const isMonday  = dow === 1;
                const isWeekend = dow === 0 || dow === 5 || dow === 6;

                let rowBg = '';
                let icon  = 'ğŸ”µ';
                if (isMonday)       { rowBg = 'background:#fdecea;'; icon = 'ğŸ”´'; }
                else if (isWeekend) { rowBg = 'background:#fffde7;'; icon = 'ğŸŸ¡'; }

                html += `<tr>
                    <td style="font-weight:bold; white-space:nowrap; ${rowBg} position:sticky; left:0; z-index:1; border-right:2px solid #dee2e6; font-size:12px;">
                        ${icon} ${month+1}/${day}(${dayName})
                    </td>`;

                if (isMonday) {
                    html += `<td style="${rowBg} color:#c62828; font-size:11px;" colspan="${staff.length}">å®šä¼‘æ—¥</td>`;
                } else {

                    staff.forEach(s => {
                        const sh = shifts.find(sh => sh.staffId === s.id && sh.date === dateStr);
                        if (sh) {
                            // æ™‚é–“ã‚’ã‚¿ãƒƒãƒ—ã§ç·¨é›†
                            html += `<td style="${rowBg} padding:4px 2px;">
                                <button onclick="openShiftEditModal(${sh.id})"
                                    style="background:#e3f2fd; color:#1565c0; border:1px solid #90caf9;
                                           border-radius:6px; padding:4px 5px; font-size:11px; font-weight:bold;
                                           cursor:pointer; width:100%; line-height:1.3; white-space:nowrap;">
                                    ${sh.start}<br>${sh.end}
                                </button>
                            </td>`;
                        } else {
                            // ç©ºæ¬„ã‚’ã‚¿ãƒƒãƒ—ã§ã‚·ãƒ•ãƒˆè¿½åŠ 
                            html += `<td style="${rowBg} padding:4px 2px;">
                                <button onclick="openShiftAddModal('${dateStr}', ${s.id})"
                                    style="background:none; color:#ccc; border:1px dashed #ddd;
                                           border-radius:6px; padding:4px 5px; font-size:13px;
                                           cursor:pointer; width:100%;">
                                    âˆ’
                                </button>
                            </td>`;
                        }
                    });
                }
                html += '</tr>';
            }

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // ã‚·ãƒ•ãƒˆæ™‚é–“ã®ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openShiftEditModal(shiftId) {
            const sh = shifts.find(s => s.id === shiftId);
            if (!sh) return;
            const staffMember = staff.find(s => s.id === sh.staffId);
            const name = staffMember ? staffMember.name : sh.staffName;

            const modal = document.getElementById('shiftEditModal');
            document.getElementById('shiftEditTitle').textContent = `${formatDate(sh.date)}ã€€${name}`;
            document.getElementById('shiftEditStart').value = sh.start;
            document.getElementById('shiftEditEnd').value   = sh.end;
            document.getElementById('shiftEditId').value    = shiftId;
            modal.classList.add('active');
        }

        // ç©ºã‚»ãƒ«ã‹ã‚‰ã‚·ãƒ•ãƒˆè¿½åŠ ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
        function openShiftAddModal(dateStr, staffId) {
            const staffMember = staff.find(s => s.id === staffId);
            if (!staffMember) return;

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ™‚é–“ï¼ˆé€±æœ«ãƒ»ç¥æ—¥ã‹åˆ¤å®šï¼‰
            const holidays = []; // è¿½åŠ æ™‚ã¯ç¥æ—¥åˆ¤å®šãªã—ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
            const hours = getShiftHours(dateStr, holidays);

            const modal = document.getElementById('shiftEditModal');
            document.getElementById('shiftEditTitle').textContent = `${formatDate(dateStr)}ã€€${staffMember.name}ã€€è¿½åŠ `;
            document.getElementById('shiftEditStart').value = hours.start;
            document.getElementById('shiftEditEnd').value   = hours.end;
            document.getElementById('shiftEditId').value    = `new_${dateStr}_${staffId}`;
            modal.classList.add('active');
        }

        function closeShiftEditModal() {
            document.getElementById('shiftEditModal').classList.remove('active');
        }

        function saveShiftEdit() {
            const rawId    = document.getElementById('shiftEditId').value;
            const newStart = document.getElementById('shiftEditStart').value;
            const newEnd   = document.getElementById('shiftEditEnd').value;

            if (!newStart || !newEnd) { alert('æ™‚é–“ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); return; }

            if (rawId.startsWith('new_')) {
                // æ–°è¦è¿½åŠ 
                const parts    = rawId.split('_');
                const dateStr  = parts[1];
                const staffId  = parseInt(parts[2]);
                const staffMember = staff.find(s => s.id === staffId);
                if (staffMember) {
                    shifts.push({
                        id: Date.now(),
                        staffId,
                        staffName: staffMember.name,
                        date: dateStr,
                        start: newStart,
                        end: newEnd
                    });
                }
            } else {
                // æ—¢å­˜ã‚·ãƒ•ãƒˆã‚’æ›´æ–°
                const shiftId = parseFloat(rawId);
                const sh = shifts.find(s => s.id === shiftId);
                if (sh) {
                    sh.start = newStart;
                    sh.end   = newEnd;
                }
            }

            saveData();
            closeShiftEditModal();
            displayShiftTable();
            displayShifts();
        }

        function deleteShiftFromModal() {
            const rawId = document.getElementById('shiftEditId').value;
            if (rawId.startsWith('new_')) { closeShiftEditModal(); return; }
            if (!confirm('ã“ã®ã‚·ãƒ•ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
            const shiftId = parseFloat(rawId);
            shifts = shifts.filter(s => s.id !== shiftId);
            saveData();
            closeShiftEditModal();
            displayShiftTable();
            displayShifts();
        }

        // PDFå‡ºåŠ›
        // PDFå‡ºåŠ› â€” å°åˆ·å°‚ç”¨ãƒšãƒ¼ã‚¸ã‚’æ–°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ã„ã¦å°åˆ·ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’èµ·å‹•
        function exportPDF() {
            const year   = parseInt(document.getElementById('viewYear').value);
            const month  = parseInt(document.getElementById('viewMonth').value) - 1;
            const period = currentViewPeriod;
            const periodLabel = period === 'first' ? 'å‰åŠï¼ˆ1ã€œ15æ—¥ï¼‰' : 'å¾ŒåŠï¼ˆ16æ—¥ã€œæœˆæœ«ï¼‰';

            let startDay, endDay;
            if (period === 'first') {
                startDay = 1; endDay = 15;
            } else {
                startDay = 16;
                endDay = new Date(year, month + 1, 0).getDate();
            }

            const dayNames = ['æ—¥','æœˆ','ç«','æ°´','æœ¨','é‡‘','åœŸ'];

            // â”€â”€ ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œï¼ˆã‚¹ã‚¿ãƒƒãƒ•åï¼‰ â”€â”€
            let headerCells = `<th style="background:#4a4a6a;color:white;padding:8px 6px;border:1px solid #999;min-width:80px;font-size:12px;">æ—¥ä»˜</th>`;
            staff.forEach(s => {
                const name = s.name.length > 5 ? s.name.slice(0, 5) + 'â€¦' : s.name;
                headerCells += `<th style="background:#4a4a6a;color:white;padding:8px 4px;border:1px solid #999;min-width:60px;font-size:11px;text-align:center;">${name}</th>`;
            });

            // â”€â”€ ãƒ‡ãƒ¼ã‚¿è¡Œ â”€â”€
            let rows = '';
            for (let day = startDay; day <= endDay; day++) {
                const dateStr  = toDateStr(year, month, day);
                const dow      = getDayOfWeek(dateStr);
                const dayName  = dayNames[dow];
                const isMonday  = dow === 1;
                const isWeekend = dow === 0 || dow === 5 || dow === 6;

                let rowBg = 'white';
                let dateLabel = `${month+1}/${day}(${dayName})`;
                let icon = '';
                if (isMonday)       { rowBg = '#fdecea'; icon = 'â—'; }
                else if (isWeekend) { rowBg = '#fffde7'; icon = 'â—†'; }

                let dateTd = `<td style="background:${rowBg};padding:6px 5px;border:1px solid #ccc;font-weight:bold;font-size:11px;white-space:nowrap;">${icon} ${dateLabel}</td>`;

                if (isMonday) {
                    const colspan = staff.length;
                    rows += `<tr>${dateTd}<td colspan="${colspan}" style="background:#fdecea;color:#c00;padding:6px;border:1px solid #ccc;font-size:11px;text-align:center;">å®šä¼‘æ—¥</td></tr>`;
                } else {
                    let cells = dateTd;
                    staff.forEach(s => {
                        const sh = shifts.find(sh => sh.staffId === s.id && sh.date === dateStr);
                        if (sh) {
                            cells += `<td style="background:${rowBg};padding:5px 3px;border:1px solid #ccc;text-align:center;font-size:11px;font-weight:bold;color:#1a237e;">${sh.start}<br>${sh.end}</td>`;
                        } else {
                            cells += `<td style="background:${rowBg};padding:5px 3px;border:1px solid #ccc;text-align:center;color:#bbb;font-size:13px;">âˆ’</td>`;
                        }
                    });
                    rows += `<tr>${cells}</tr>`;
                }
            }

            const html = `<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>${year}å¹´${month+1}æœˆ ã‚·ãƒ•ãƒˆè¡¨</title>
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family: 'Hiragino Kaku Gothic Pro', Meiryo, sans-serif; padding: 20px; }
  h1 { text-align:center; font-size:18px; margin-bottom:6px; color:#333; }
  .legend { display:flex; gap:20px; justify-content:center; margin-bottom:12px; font-size:11px; color:#555; }
  table { border-collapse:collapse; width:100%; }
  @media print {
    body { padding: 10px; }
    @page { size: A4 portrait; margin: 10mm; }
  }
</style>
</head>
<body>
  <h1>ğŸ¢ ${year}å¹´${month+1}æœˆ ${periodLabel} ã‚·ãƒ•ãƒˆè¡¨</h1>
  <div class="legend">
    <span>â— å®šä¼‘æ—¥ï¼ˆæœˆæ›œï¼‰</span>
    <span>â—† é€±æœ«ï¼ˆé‡‘åœŸæ—¥ï¼‰17:00ã€œ22:00</span>
    <span>å¹³æ—¥ 18:00ã€œ22:00</span>
  </div>
  <table>
    <thead><tr>${headerCells}</tr></thead>
    <tbody>${rows}</tbody>
  </table>
  <script>
    window.onload = function() { window.print(); };
  <\/script>
</body>
</html>`;

            const win = window.open('', '_blank');
            win.document.write(html);
            win.document.close();
        }

        // å¹´ã‚»ãƒ¬ã‚¯ãƒˆãƒœãƒƒã‚¯ã‚¹ã‚’åˆæœŸåŒ–
        function initYearSelect() {
            const autoSelect = document.getElementById('autoYear');
            const viewSelect = document.getElementById('viewYear');
            const currentYear = new Date().getFullYear();
            
            for (let year = currentYear - 1; year <= currentYear + 2; year++) {
                const autoOption = document.createElement('option');
                autoOption.value = year;
                autoOption.textContent = `${year}å¹´`;
                if (year === currentYear) {
                    autoOption.selected = true;
                }
                autoSelect.appendChild(autoOption);
                
                const viewOption = document.createElement('option');
                viewOption.value = year;
                viewOption.textContent = `${year}å¹´`;
                if (year === currentYear) {
                    viewOption.selected = true;
                }
                viewSelect.appendChild(viewOption);
            }
        }

        // åˆæœŸåŒ–
        loadData();
        initYearSelect();
        
        // ç¾åœ¨ã®æœˆã‚’è¨­å®š
        const now = new Date();
        document.getElementById('autoMonth').value = now.getMonth() + 1;
        document.getElementById('viewMonth').value = now.getMonth() + 1;
        
        // è¡¨ç¤ºã‚¿ãƒ–ã®æœˆãƒ»å¹´å¤‰æ›´æ™‚ã«ã‚·ãƒ•ãƒˆè¡¨ã‚’æ›´æ–°
        document.getElementById('viewYear').addEventListener('change', displayShiftTable);
        document.getElementById('viewMonth').addEventListener('change', displayShiftTable);
        
        updateAvailabilityForm();
        displayStaff();
        updateStaffSelect();
        displayShifts();
        displayShiftTable();
        
        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’åˆæœŸåŒ–
        renderCalendar('availableCalendar', availableCalendarMonth, tempAvailableDates, 'available');
        renderCalendar('blockedCalendar', blockedCalendarMonth, tempBlockedDates, 'blocked');

        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’è¨­å®š
        const today = new Date();
        document.getElementById('shiftDate').valueAsDate = today;
    </script>
    <!-- ã‚·ãƒ•ãƒˆæ™‚é–“ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="shiftEditModal" class="modal">
        <div class="modal-content" style="max-width:360px;">
            <div class="modal-header">
                <h3 id="shiftEditTitle" style="font-size:16px;"></h3>
                <button class="close-btn" onclick="closeShiftEditModal()">&times;</button>
            </div>
            <input type="hidden" id="shiftEditId">
            <div class="form-group">
                <label>é–‹å§‹æ™‚é–“</label>
                <input type="time" id="shiftEditStart">
            </div>
            <div class="form-group">
                <label>çµ‚äº†æ™‚é–“</label>
                <input type="time" id="shiftEditEnd">
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-primary" style="flex:2;" onclick="saveShiftEdit()">ä¿å­˜</button>
                <button class="btn btn-danger"  style="flex:1;" onclick="deleteShiftFromModal()">å‰Šé™¤</button>
            </div>
        </div>
    </div>
</body>
</html>
